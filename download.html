<html>

<head lang="en">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <style>
        @import url(https://fonts.googleapis.com/css?family=Dancing%20Script);
    </style>
</head>

<body>
    <input id="debug" type="text" name="debug" value="" />
    <a id="download" name="download" href="" download="AwesomeImage.png">
        <img class="" id="preview" name="preview" /></a>
    <canvas id="targetCanvas" width="1080" height="1500" hidden></canvas>

</body>

<script>

    var img_source = [];
    var username = "clhjoe";
    var data = '{"code":0,"data":{"post_list":[{"like_count":2,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/128226650_211821187006405_6784883661190994103_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=101\u0026_nc_ohc=aLVJe7ISxeQAX8etSNG\u0026tp=1\u0026oh=610403c2bf55ede293388326b0c2d2b5\u0026oe=5FF6E75A\u0026ig_cache_key=MjQ1NDM0ODA3MDk0OTY4OTc3OQ%3D%3D.2"},{"like_count":2,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/129349433_2759594584315252_7321886149559309082_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=104\u0026_nc_ohc=5r97cbcPwP8AX-kycsW\u0026tp=1\u0026oh=68b92d04e0e377564340d9f914b82450\u0026oe=5FF6E142\u0026ig_cache_key=MjQ1NTE5MjQxNzQ5NjUyODUxMg%3D%3D.2"},{"like_count":1,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/128468430_1224167057965552_6124158763526966210_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=104\u0026_nc_ohc=pmngoXxlo9cAX-JUsvD\u0026tp=1\u0026oh=b9195a2743ce4efb87f2aea83796329a\u0026oe=5FF7A2EA\u0026ig_cache_key=MjQ1NDM1MzMxOTgxOTAyMDI2NA%3D%3D.2"},{"like_count":1,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/129064311_174761744377781_8195773196871725231_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=105\u0026_nc_ohc=ebhtBRwAcdkAX9n7LLR\u0026tp=1\u0026oh=8eb5d873cfdcb0757e315368db487088\u0026oe=5FF846A8\u0026ig_cache_key=MjQ1NDM0ODQ0ODIzNTY2NjY0NA%3D%3D.2"},{"like_count":1,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/128574994_801436494056428_1331936937856492061_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=104\u0026_nc_ohc=-JvpKrwfausAX-ZWmq6\u0026tp=1\u0026oh=a260d9739459fdc94d8f242c86dbea8a\u0026oe=5FF704CF\u0026ig_cache_key=MjQ1NDM0ODYxOTc3NDQyMzgzMQ%3D%3D.2"},{"like_count":1,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/129119995_401839144347685_1101495077940202338_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=101\u0026_nc_ohc=RxROt4yt8doAX_L0NrI\u0026tp=1\u0026oh=83511dd7471824713fe567ef11d361c6\u0026oe=5FF89BDB\u0026ig_cache_key=MjQ1NDM1MDc4NTAzMzQ5MzM4OQ%3D%3D.2"},{"like_count":1,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/128710211_150105366867288_3540725260301173733_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=100\u0026_nc_ohc=Jq6WhCBaf0QAX89rQvr\u0026tp=1\u0026oh=a9fc9cbde8b00edba07fb5307a3b5f83\u0026oe=5FF9357D\u0026ig_cache_key=MjQ1NTE5MTMzNTk2MTYzMTAwMg%3D%3D.2"},{"like_count":1,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/127098925_198012401797152_937087688091247570_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=100\u0026_nc_ohc=cV1H16SNF8YAX8Dyw3r\u0026tp=1\u0026oh=bfbcd617ac56fb19f98f00132182dcf2\u0026oe=5FF7E32F\u0026ig_cache_key=MjQ1MDEwODUzOTUwMTIzMDUzNA%3D%3D.2"},{"like_count":0,"url":"https://scontent-sea1-1.cdninstagram.com/v/t51.2885-15/e35/s1080x1080/129397025_1528377050701415_1946404991268665800_n.jpg?_nc_ht=scontent-sea1-1.cdninstagram.com\u0026_nc_cat=111\u0026_nc_ohc=_Kk8kgYjzzIAX-souTh\u0026tp=1\u0026oh=43c0c4a69e54c2f68a2df95f1634cea3\u0026oe=5FF98193\u0026ig_cache_key=MjQ1NTE5MDU3NzMyMTIwOTY2Ng%3D%3D.2"}],"total_liked_count":10,"total_post_count":19},"url":""}';

    $(document).ready(function () {
        start();
    })

    function start() {
        console.log("[start]" + JSON.parse(data).data);
        show_preview_crop(JSON.parse(data).data);
    }
    function loadImages(img_source, callback) {
        var images = [];
        var loadedImages = 0;
        var numImages = 0;
        // get num of img_source
        for (var src in img_source) {
            numImages++;
        }
        for (i = 0; i < img_source.length; i++) {
            images[i] = new Image();
            images[i].setAttribute("crossOrigin", 'Anonymous');
            images[i].onload = function () {
                if (++loadedImages >= numImages) {
                    callback(images);
                }
            };
            images[i].src = img_source[i];
        }
    }


    var canvas = document.getElementById('targetCanvas');
    var context = canvas.getContext('2d');

    function drawRectanlesBorders(img, x, y, width, height, deg) {
        var c = document.getElementById("targetCanvas");
        var ctx = c.getContext("2d");
        var rad = deg * Math.PI / 180;

        ctx.save();
        ctx.translate(x + width / 2, y + height / 2);
        ctx.rotate(rad);
        ctx.beginPath();
        ctx.rect(width / 2 * (-1), height / 2 * (-1), width, height);
        ctx.lineWidth = 5;
        ctx.strokeStyle = 'white';
        ctx.stroke();
        ctx.restore();
    }



    function drawImageRot_crop(img, x, y, crop_size, grid_width) {

        var c = document.getElementById("targetCanvas");
        var ctx = c.getContext("2d");

        console.log(0, 0, crop_size, crop_size, x, y, grid_width, grid_width);
        ctx.drawImage(img, 0, 0, crop_size, crop_size, x, y, grid_width, grid_width);
        ctx.restore();
    }

    function nFormatter(num, digits) {
        var si = [
            { value: 1, symbol: "" },
            { value: 1E3, symbol: "k" },
            { value: 1E6, symbol: "M" },
            { value: 1E9, symbol: "G" },
            { value: 1E12, symbol: "T" },
            { value: 1E15, symbol: "P" },
            { value: 1E18, symbol: "E" }
        ];
        var rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
        var i;
        for (i = si.length - 1; i > 0; i--) {
            if (num >= si[i].value) {
                break;
            }
        }
        return (num / si[i].value).toFixed(digits).replace(rx, "$1") + si[i].symbol;
    }
    function show_preview_crop(data) {
        var c = document.getElementById("targetCanvas");
        var ctx = c.getContext("2d");
        ctx.fillStyle = "#fafafa";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for (i = 0; i < data.post_list.length; i++) {
            img_source[i] = data.post_list[i].url;
        }
        loadImages(img_source, function (images) {
            var c = document.getElementById("targetCanvas");
            rowSize = Math.ceil(Math.sqrt(img_source.length));
            console.log(rowSize);
            bording_padding = 10;
            padding = 3;
            width = Math.floor((c.width - (bording_padding * 2)) / rowSize);
            height = width;

            grid_width = width - (rowSize - 1 * padding);
            grid_height = grid_width;
            x_padding = padding;
            y_padding = padding;
            for (i = 0; i < img_source.length; i++) {
                y = bording_padding + (grid_width + y_padding) * Math.floor(i / rowSize)
                x = bording_padding + (x_padding + grid_width) * (i % rowSize);
                drawRectanlesBorders(img_source[i], x, y, grid_width, grid_height, 0);
                crop_size = images[i].width;
                if (images[i].width > images[i].height) {
                    crop_size = images[i].height;
                }

                like_font_x = x + 10;
                like_font_y = y + 5;
                like_text = nFormatter(data.post_list[i].like_count) + " ‚ù§";
                like_font = "35px Roboto";
                drawImageRot_crop(images[i], x, y, crop_size, grid_width);
                ctx.textBaseline = 'top';                //print like count
                ctx.fillStyle = 'white';                /// color for background  
                ctx.globalAlpha = 0.7;
                ctx.font = like_font;
                var like_width = ctx.measureText(like_text).width;/// get width of text   
                ctx.fillRect(x, y, like_width + 20, 40);/// draw background rect assuming height of font
                ctx.textBaseline = '';
                ctx.globalAlpha = 1;
                ctx.fillStyle = "red";
                // ctx.textAlign = "center";
                console.log(like_text, like_font_x, like_font_y);
                ctx.fillText(like_text, like_font_x, like_font_y);
            }
            //draw text
            var text = ["@" + username + " receieved ", nFormatter(data.total_liked_count) + " Likes", " in 2020~ üéä"];
            var text_length = [];
            var total_text_length = 0;
            var normal_font = "40px Roboto";
            ctx.fillStyle = "#232324";

            var bold_font = "bold " + normal_font;
            for (i = 0; i < text.length; i++) {
                if (i == 1) {
                    ctx.font = bold_font;
                } else {
                    ctx.font = normal_font;
                }
                text_length[i] = ctx.measureText(text[i]).width;
                total_text_length += text_length[i];
            }
            var start_x = (c.width - total_text_length) / 2;
            for (i = 0; i < text.length; i++) {
                if (i == 1) {
                    ctx.font = bold_font;
                } else {
                    ctx.font = normal_font;
                }
                if (i != 0) {
                    start_x += text_length[i - 1];
                }
                console.log(text[i], start_x, width * rowSize + 120);
                ctx.fillText(text[i], start_x, width * rowSize + 120);
            }

            //foot
            ctx.textAlign = "center";
            ctx.font = "70px Dancing Script";
            ctx.fillText("Best  of  2020", c.width / 2, width * rowSize + 260);

            ctx.font = "30px roboto"
            ctx.fillText("https://top9.space", c.width / 2, c.height - 30);

            ctx.restore();
            //export to img
            //var img = c.toDataURL("image/png");
            // $("#download").attr("href", c.toDataURL("image/png").replace("image/png", "image/octet-stream"));
            // $("#download").attr("download", username + "_top9_of_2020");
            // $("#download").click();
            var link = document.getElementById('download');
            link.setAttribute('download', 'MintyPaper.png');
            link.setAttribute('href', c.toDataURL("image/png").replace("image/png", "image/octet-stream"));
            link.click();

        });
    }

</script>

</html>